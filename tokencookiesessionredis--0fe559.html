<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<!-- iOS Safari -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<!-- Chrome, Firefox OS and Opera Status Bar Color -->
<meta name="theme-color" content="#FFFFFF">
<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.11.1/katex.min.css">
<link rel="stylesheet" type="text/css"
  href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.19.0/themes/prism.min.css">
<link rel="stylesheet" type="text/css" href="css/SourceSansPro.css">
<link rel="stylesheet" type="text/css" href="css/theme.css">
<link rel="stylesheet" type="text/css" href="css/notablog.css">
<!-- Favicon -->

<style>
  :root {
    font-size: 20px;
  }
</style>
  <title>token，cookie，session与redis &nbsp;|&nbsp;沂风</title>
  <meta property="og:type" content="blog">
  <meta property="og:title" content="token，cookie，session与redis ">
  
    <meta name="description" content="cookid，session，token与项目开发用户校验">
    <meta property="og:description" content="cookid，session，token与项目开发用户校验">
  
  
    <meta property="og:image" content="data:image/svg+xml,&lt;svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22&gt;&lt;text text-anchor=%22middle%22 dominant-baseline=%22middle%22 x=%2250%22 y=%2255%22 font-size=%2280%22&gt;📪&lt;/text&gt;&lt;/svg&gt;">
  
  <style>
    .DateTagBar {
      margin-top: 1.0rem;
    }
  </style>
</head>

<body>
  <nav class="Navbar">
  <a href="index.html">
    <div class="Navbar__Btn">
      
      <span>Home</span>
    </div>
  </a>
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <span class="Navbar__Delim">&centerdot;</span>
      <a href="about.html">
        <div class="Navbar__Btn">
          
            <span><img class="inline-img-icon" src="data:image/svg+xml,&lt;svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22&gt;&lt;text text-anchor=%22middle%22 dominant-baseline=%22middle%22 x=%2250%22 y=%2255%22 font-size=%2280%22&gt;😀&lt;/text&gt;&lt;/svg&gt;"></span>&nbsp;
          
          <span>关于</span>
        </div>
      </a>
    
  
    
  
    
  
</nav>
  <header class="Header">
    
      <div class="Header__Cover">
        <img src="https://www.notion.so/images/page-cover/nasa_earth_grid.jpg">
      </div>
    
    <div class="Header__Spacer ">
    </div>
    
      <div class="Header__Icon">
        <span><img class="inline-img-icon" src="data:image/svg+xml,&lt;svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22&gt;&lt;text text-anchor=%22middle%22 dominant-baseline=%22middle%22 x=%2250%22 y=%2255%22 font-size=%2280%22&gt;📪&lt;/text&gt;&lt;/svg&gt;"></span>
      </div>
    
    <h1 class="Header__Title">token，cookie，session与redis </h1>
    
      <div class="DateTagBar">
        
          <span class="DateTagBar__Item DateTagBar__Date">Posted on Sun, Sep 3, 2023</span>
        
        
          <span class="DateTagBar__Item DateTagBar__Tag DateTagBar__Tag--orange">
            <a href="tag/项目开发.html">项目开发</a>
          </span>
        
      </div>
    
  </header>
  <article id="https://www.notion.so/0fe559d588d942ba8ac35807024c5ae5" class="PageRoot"><ul id="https://www.notion.so/a16097f4cebb4ed8bf0cc9279aad362d" class="ColorfulBlock ColorfulBlock--ColorGray TableOfContents"><li class="TableOfContents__Item"><a href="#https://www.notion.so/d4bbfb980a6342bca12ef4ba32a31f07"><div style="margin-left:0px"><span class="SemanticStringArray"><span class="SemanticString">cookie</span></span></div></a></li><li class="TableOfContents__Item"><a href="#https://www.notion.so/eb687f1708ea4ef194e15ac839940b43"><div style="margin-left:24px"><span class="SemanticStringArray"><span class="SemanticString">我们都知道一般接口但是通过 HTTP 协议来进行数据交换的，而 HTTP 协议的特点是，无状态，工作前通过三次握手建立连接，工作完成后立刻通过四次挥手断开连接，每次连接都是独立存在的，没有任何状态将请求串联成一个整体，因此每次都需要重新验证是身份，即耗费了性能，也给黑客的攻击留下隐患。</span></span></div></a></li><li class="TableOfContents__Item"><a href="#https://www.notion.so/d87e39ddaa5f4ebb9f19495751ea9d62"><div style="margin-left:24px"><span class="SemanticStringArray"><span class="SemanticString">会话Cookie</span></span></div></a></li><li class="TableOfContents__Item"><a href="#https://www.notion.so/2ad2bbf51837433cafcbeff2e8a3c4a6"><div style="margin-left:24px"><span class="SemanticStringArray"><span class="SemanticString">持久性 Cookie</span></span></div></a></li><li class="TableOfContents__Item"><a href="#https://www.notion.so/13add3494d96422e973ba1e8a617bc03"><div style="margin-left:0px"><span class="SemanticStringArray"><span class="SemanticString">Session</span></span></div></a></li><li class="TableOfContents__Item"><a href="#https://www.notion.so/491405590a0e4313b2dc15d4e8ea5f83"><div style="margin-left:24px"><span class="SemanticStringArray"><span class="SemanticString">服务器使用session把用户的信息临时保存在了服务器上，用户离开网站后session会被销毁。这种用户信息存储方式相对cookie来说更安全，可是session有一个缺陷：如果web服务器做了负载均衡，那么下一个操作请求到了另一台服务器的时候session会丢失。</span></span></div></a></li><li class="TableOfContents__Item"><a href="#https://www.notion.so/bce2d23800ea42899d0a7fa78d084bc7"><div style="margin-left:0px"><span class="SemanticStringArray"><span class="SemanticString">Session如何判断是同一对话</span></span></div></a></li><li class="TableOfContents__Item"><a href="#https://www.notion.so/30fc3be4971b47b781aa2ddc36cb694f"><div style="margin-left:0px"><span class="SemanticStringArray"><span class="SemanticString">Token</span></span></div></a></li><li class="TableOfContents__Item"><a href="#https://www.notion.so/f85b29aaba5a413f9aed173aab784a73"><div style="margin-left:0px"><span class="SemanticStringArray"><span class="SemanticString">有了cookie为什么要用token</span></span></div></a></li><li class="TableOfContents__Item"><a href="#https://www.notion.so/87a741f8f6964ee7bb76484d5e4ff67e"><div style="margin-left:0px"><span class="SemanticStringArray"><span class="SemanticString">Cookie与Token存储内容的区别</span></span></div></a></li><li class="TableOfContents__Item"><a href="#https://www.notion.so/cf5f7a70fa8048a5b8d4133730af31ed"><div style="margin-left:24px"><span class="SemanticStringArray"><span class="SemanticString">session</span></span></div></a></li><li class="TableOfContents__Item"><a href="#https://www.notion.so/a33f70f6ab654daa954922a58e35598c"><div style="margin-left:24px"><span class="SemanticStringArray"><span class="SemanticString">token</span></span></div></a></li><li class="TableOfContents__Item"><a href="#https://www.notion.so/c2ce0914a64949e1b102e4ab8eb86712"><div style="margin-left:48px"><span class="SemanticStringArray"><span class="SemanticString">用户输入登录信息服务器判断登录信息正确，返回一个 tokentoken 存储在客户端，大多数通常在 local storage，但是也可以存储在 session storage 或者 cookie 中。</span></span></div></a></li><li class="TableOfContents__Item"><a href="#https://www.notion.so/513c998e9ec2492babccdabf96465d7e"><div style="margin-left:24px"><span class="SemanticStringArray"><span class="SemanticString">Token加密问题</span></span></div></a></li><li class="TableOfContents__Item"><a href="#https://www.notion.so/cc813867d95340dc902651614ebcc05b"><div style="margin-left:48px"><span class="SemanticStringArray"><span class="SemanticString">单向加密</span></span></div></a></li><li class="TableOfContents__Item"><a href="#https://www.notion.so/f404090c77e248f89b3b4f1b5f4e4e65"><div style="margin-left:72px"><span class="SemanticStringArray"><span class="SemanticString">MD5</span></span></div></a></li><li class="TableOfContents__Item"><a href="#https://www.notion.so/7ab92376cfdd45498d8cc5324142ac03"><div style="margin-left:72px"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">Hmac</strong></span></span></div></a></li><li class="TableOfContents__Item"><a href="#https://www.notion.so/597602c731f145e4a8bdce0f59d7837c"><div style="margin-left:48px"><span class="SemanticStringArray"><span class="SemanticString">双向加密</span></span></div></a></li><li class="TableOfContents__Item"><a href="#https://www.notion.so/cc4c16cac95f4cd4a47831924fed1c14"><div style="margin-left:72px"><span class="SemanticStringArray"><span class="SemanticString">对称加密-DES 3DES AES</span></span></div></a></li><li class="TableOfContents__Item"><a href="#https://www.notion.so/38dd35a7874c48fe8a2d56a93a588f85"><div style="margin-left:72px"><span class="SemanticStringArray"><span class="SemanticString">非对称加密-RSA算法</span></span></div></a></li><li class="TableOfContents__Item"><a href="#https://www.notion.so/fb30b74e9b934e889674de6093f98458"><div style="margin-left:48px"><span class="SemanticStringArray"><span class="SemanticString">利用加密算法实现一个token</span></span></div></a></li><li class="TableOfContents__Item"><a href="#https://www.notion.so/842f0b879955417f82ded24ebf51a243"><div style="margin-left:24px"><span class="SemanticStringArray"><span class="SemanticString">Token中都存储什么信息</span></span></div></a></li><li class="TableOfContents__Item"><a href="#https://www.notion.so/5f2f2edcace4426088663428c510456e"><div style="margin-left:24px"><span class="SemanticStringArray"><span class="SemanticString">Token过期刷新策略（利用Redis）（大型项目）</span></span></div></a></li><li class="TableOfContents__Item"><a href="#https://www.notion.so/16956852e3f24beb85e0887455cfd42b"><div style="margin-left:48px"><span class="SemanticStringArray"><span class="SemanticString">设计思路</span></span></div></a></li><li class="TableOfContents__Item"><a href="#https://www.notion.so/4a66c87925e940318db0860b8e1fa03a"><div style="margin-left:24px"><span class="SemanticStringArray"><span class="SemanticString">二次迭代（小型项目）</span></span></div></a></li></ul><div id="https://www.notion.so/79dad93fe7a64dc48a1142020b98950a" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">参考文章：</span><span class="SemanticString"><a class="SemanticString__Fragment SemanticString__Fragment--Link" href="https://mp.weixin.qq.com/s/yzgKBboS84uUvAubqUtqdQ">https://mp.weixin.qq.com/s/yzgKBboS84uUvAubqUtqdQ</a></span></span></p></div><div id="https://www.notion.so/810203faf6ba494f9ac9fc064dfadbfe" class="Image Image--PageWidth"><figure><a href="https://prod-files-secure.s3.us-west-2.amazonaws.com/97f60ed7-2f91-4328-9e16-bcc075d7c8a7/c17ba07e-410f-4b81-9bb9-2a3689832c89/Untitled.png?width=1644"><img src="https://prod-files-secure.s3.us-west-2.amazonaws.com/97f60ed7-2f91-4328-9e16-bcc075d7c8a7/c17ba07e-410f-4b81-9bb9-2a3689832c89/Untitled.png?width=1644" style="width:100%"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div><div id="https://www.notion.so/1748589830574d16a2e9f334edaa9c02" class="Image Image--PageWidth"><figure><a href="https://prod-files-secure.s3.us-west-2.amazonaws.com/97f60ed7-2f91-4328-9e16-bcc075d7c8a7/19b0e99d-3578-4002-89d5-5e4d89f5c1c7/Untitled.png?width=1976"><img src="https://prod-files-secure.s3.us-west-2.amazonaws.com/97f60ed7-2f91-4328-9e16-bcc075d7c8a7/19b0e99d-3578-4002-89d5-5e4d89f5c1c7/Untitled.png?width=1976" style="width:100%"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div><h1 id="https://www.notion.so/d4bbfb980a6342bca12ef4ba32a31f07" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--1"><a class="Anchor" href="#https://www.notion.so/d4bbfb980a6342bca12ef4ba32a31f07"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">cookie</span></span></h1><div id="https://www.notion.so/a758c80db3a44e228db38a9f72ee83ca" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/f39d12157b114e51a6f553c7cd6aac53" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">HTTP 协议中的 Cookie 包括 </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">Web Cookie</code></span><span class="SemanticString">
 和</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">浏览器 Cookie</code></span><span class="SemanticString">
，它是服务器发送到 Web 浏览器的一小块数据。服务器发送到浏览器的 Cookie，浏览器会进行存储，并与下一个请求一起发送到服务器。通常，它用于判断两个请求是否来自于同一个浏览器，例如用户保持登录状态。</span></span></p></div><h3 id="https://www.notion.so/eb687f1708ea4ef194e15ac839940b43" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--3"><a class="Anchor" href="#https://www.notion.so/eb687f1708ea4ef194e15ac839940b43"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">我们都知道一般接口但是通过 HTTP 协议来进行数据交换的，而 HTTP 协议的特点是，无状态，工作前通过三次握手建立连接，工作完成后立刻通过四次挥手断开连接，每次连接都是独立存在的，没有任何状态将请求串联成一个整体，因此每次都需要重新验证是身份，即耗费了性能，也给黑客的攻击留下隐患。</span></span></h3><div id="https://www.notion.so/a384a7d681b74e9fa8771f8f6076f9c7" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">那么 Cookie 的作用是什么呢，它的出现，就是来弥补 HTTP 无状态的问题的，</span></span></p></div><div id="https://www.notion.so/4c942f71a966492c846bd639b6435f28" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Cookie 可以作为一个状态保存的状态机，用来保存用户的相关登录状态，当第一次验证通过后，服务器可以通过 set-cookie 令客户端将自己的 cookie 保存起来，当下一次再发送请求的时候，直接带上 cookie 即可，而服务器检测到客户端发送的 cookie 与其保存的 cookie 值保持一致时，则直接信任该连接，不再进行验证操作。大致的过程如下图</span></span></p></div><div id="https://www.notion.so/8ccb7e3f84d947068689b160015dc285" class="Image Image--PageWidth"><figure><a href="https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2Fb3e24f1a-8f01-4b5a-885d-d52a127fb07f%2FUntitled.png?width=1924&amp;table=block&amp;id=8ccb7e3f-84d9-4706-8689-b160015dc285"><img src="https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2Fb3e24f1a-8f01-4b5a-885d-d52a127fb07f%2FUntitled.png?width=1924&amp;table=block&amp;id=8ccb7e3f-84d9-4706-8689-b160015dc285" style="width:100%"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div><h3 id="https://www.notion.so/d87e39ddaa5f4ebb9f19495751ea9d62" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--3"><a class="Anchor" href="#https://www.notion.so/d87e39ddaa5f4ebb9f19495751ea9d62"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">会话Cookie</span></span></h3><div id="https://www.notion.so/1c454c60e58745dbb7981b87822a7551" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">在 Session Cookies 中，用户的登录状态会保存在</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">服务器</code></span><span class="SemanticString">的</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">内存</code></span><span class="SemanticString">中。当用户登录时，Session 就被服务端安全的创建。</span></span></p></div><div id="https://www.notion.so/61e28dc1f54346b6a658851d6b5c1d62" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">在每次请求时，服务器都会从会话 Cookie 中读取 SessionId，如果服务端的数据和读取的 SessionId 相同，那么服务器就会发送响应给浏览器，允许用户登录。</span></span></p></div><div id="https://www.notion.so/cb4d2e49d46143949a90af4c211d3b5a" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">会话 Cookie 存储在内存中，永远不会写入磁盘，当浏览器关闭时，此后 Cookie 将永久丢失。</span></span></p></div><h3 id="https://www.notion.so/2ad2bbf51837433cafcbeff2e8a3c4a6" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--3"><a class="Anchor" href="#https://www.notion.so/2ad2bbf51837433cafcbeff2e8a3c4a6"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">持久性 Cookie</span></span></h3><div id="https://www.notion.so/08a70aed1c114253b182c2bda1e92cf7" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">如果 Cookie 包含</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">有效期</code></span><span class="SemanticString">，则将其视为持久性 Cookie。在到期指定的日期，Cookie 将从磁盘中删除。</span></span></p></div><div id="https://www.notion.so/d401917ccd124020a6890be73abc42d3" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">永久性 Cookie 不会在客户端关闭时过期，而是在</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">特定日期（Expires）</code></span><span class="SemanticString">或</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">特定时间长度（Max-Age）</code></span><span class="SemanticString">
外过期</span></span></p></div><h1 id="https://www.notion.so/13add3494d96422e973ba1e8a617bc03" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--1"><a class="Anchor" href="#https://www.notion.so/13add3494d96422e973ba1e8a617bc03"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">Session</span></span></h1><div id="https://www.notion.so/ce58da246f484d729df53d87fa46f4f5" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">session 从字面上讲，就是会话。这个就类似于你和一个人交谈，你怎么知道当前和你交谈的是张三而不是李四呢？对方肯定有某种特征（长相等）表明他就是张三。</span></span></p></div><div id="https://www.notion.so/5eb3003ce2ec45089ca7b14f79b39679" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">session 也是类似的道理，服务器要知道当前发请求给自己的是谁。为了做这种区分，服务器就要给每个客户端分配不同的“身份标识”，然后客户端每次向服务器发请求的时候，都带上这个“身份标识”，服务器就知道这个请求来自于谁了。至于客户端怎么保存这个“身份标识”，可以有很多种方式，对于浏览器客户端，大家都默认采用 cookie 的方式。</span></span></p></div><h3 id="https://www.notion.so/491405590a0e4313b2dc15d4e8ea5f83" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--3"><a class="Anchor" href="#https://www.notion.so/491405590a0e4313b2dc15d4e8ea5f83"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">服务器使用session把用户的信息临时保存在了服务器上，用户离开网站后session会被销毁。这种用户信息存储方式相对cookie来说更安全，可是session有一个缺陷：如果web服务器做了负载均衡，那么下一个操作请求到了另一台服务器的时候session会丢失。</span></span></h3><div id="https://www.notion.so/d4b0dcbda21146bd8387f688c3dbc6a8" class="Image Image--PageWidth"><figure><a href="https://prod-files-secure.s3.us-west-2.amazonaws.com/97f60ed7-2f91-4328-9e16-bcc075d7c8a7/75f17160-749d-4a5b-96da-e94dbecb2c27/Untitled.png?width=1490"><img src="https://prod-files-secure.s3.us-west-2.amazonaws.com/97f60ed7-2f91-4328-9e16-bcc075d7c8a7/75f17160-749d-4a5b-96da-e94dbecb2c27/Untitled.png?width=1490" style="width:100%"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div><h2 id="https://www.notion.so/bce2d23800ea42899d0a7fa78d084bc7" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/bce2d23800ea42899d0a7fa78d084bc7"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">Session如何判断是同一对话</span></span></h2><div id="https://www.notion.so/7b3f2e16c7c14f2dad93ce66764ddf44" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">服务器第一次接收到请求时，开辟了一块 Session 空间（创建了Session对象），同时生成一个 sessionId ，并通过响应头的 Set-Cookie：JSESSIONID=XXXXXXX 命令，向客户端发送要求设置 Cookie 的响应；客户端收到响应后，在本机客户端设置了一个 JSESSIONID=XXXXXXX 的 Cookie 信息，该 Cookie 的过期时间为浏览器会话结束。</span></span></p></div><h1 id="https://www.notion.so/30fc3be4971b47b781aa2ddc36cb694f" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--1"><a class="Anchor" href="#https://www.notion.so/30fc3be4971b47b781aa2ddc36cb694f"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">Token</span></span></h1><div id="https://www.notion.so/8c321a01eaed4465a2c742692fb3d3a8" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Token，简单来说，就是类似 cookie 的一种验证信息，客户端通过登录验证后，服务器会返回给客户端一个加密的 token，然后当客户端再次向服务器发起连接时，带上token，服务器直接对token进行校验即可完成权限校验。</span></span></p></div><div id="https://www.notion.so/1eff7efa644a46c7b1ffca60f6aa5f6d" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Token 的传递过程和 Cookie 差不多，依然是通过验证后返回，然后存储到客户端，当下一次再次发起请求时，携带该验证信息进行快速验证。如下图</span></span></p></div><div id="https://www.notion.so/02c9de308f234e0ebc9211d07ea8147b" class="Image Image--PageWidth"><figure><a href="https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F08097371-cc33-4920-8ed1-77b062409b5f%2FUntitled.png?width=1818&amp;table=block&amp;id=02c9de30-8f23-4e0e-bc92-11d07ea8147b"><img src="https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F08097371-cc33-4920-8ed1-77b062409b5f%2FUntitled.png?width=1818&amp;table=block&amp;id=02c9de30-8f23-4e0e-bc92-11d07ea8147b" style="width:100%"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div><div id="https://www.notion.so/f8a6f17ae866436fa23061f9c0a531fa" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/0d07468c39a94474a5d76e46e315712c" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><h1 id="https://www.notion.so/f85b29aaba5a413f9aed173aab784a73" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--1"><a class="Anchor" href="#https://www.notion.so/f85b29aaba5a413f9aed173aab784a73"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">有了cookie为什么要用token</span></span></h1><div id="https://www.notion.so/7ef58bf6f8a34c6b88ac5a305861ee25" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Cookie 作为 HTTP 规范，其出现历史久远，因此存在一些历史遗留问题，比如跨域限制等，并且 Cookie 作为 HTTP 规范中的内容，其存在默认存储以及默认发送的行为，存在一定的安全性问题。相较于 Cookie，token 需要自己存储，自己进行发送，不存在跨域限制，因此 Token 更加的灵活，没有 Cookie 那么多的“历史包袱”束缚，在安全性上也能够做更多的优化。</span></span></p></div><div id="https://www.notion.so/e902a22ef6004064a78aa62add171653" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/f20719c3f1a44a5b944e537add0a63d7" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Cookie 由于存储的内存空间只有 4kb，因此存储的主要是一个用户 id，其他的用户信息都存储在服务器的 Session 中，而 Token 没有内存限制，用户信息可以存储 Token 中，返回给用户自行存储，因此可以看出，采用 Cookie 的话，由于所有用户都需要在服务器的 Session 中存储相对应的用户信息，所以如果用户量非常大，这对于服务器来说，将是非常大的性能压力，而Token 将用户信息返回给客户端各自存储，也就完全避开这个问题了。</span></span></p></div><div id="https://www.notion.so/3d18be97ef994398a4071e86b80ce176" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">其实 token 和 session 的验证机制最大的区别是用“签名验证机制”代替了“白名单验证机制”。
session 的问题在于前端传来的 session_id 可以伪造，所以必须在服务器维护一个 session_id 的白名单来验证 session_id 的合法性。token 的改进之处就在这里，token 通过签名机制，只要前端传来的 token 能通过签名认证就是合法的，不需要服务器维护任何东西，所有的需要东西都放在在 token 里面。
token 里面一般都会放上 user_id，否则就得到服务器维护一个 token 到 user_id 的映射，这样意义就不大了。</span></span></p></div><div id="https://www.notion.so/9293a7a5bca246faa8be2cdc259a731e" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><h1 id="https://www.notion.so/87a741f8f6964ee7bb76484d5e4ff67e" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--1"><a class="Anchor" href="#https://www.notion.so/87a741f8f6964ee7bb76484d5e4ff67e"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">Cookie与Token存储内容的区别</span></span></h1><h2 id="https://www.notion.so/cf5f7a70fa8048a5b8d4133730af31ed" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/cf5f7a70fa8048a5b8d4133730af31ed"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">session</span></span></h2><div id="https://www.notion.so/c21e5cdd20b74a5ca7e6a2f3ed5bf225" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">用户登录，输入账号密码服务器验证用户账号密码正确，</span></span></p></div><div id="https://www.notion.so/2bdcf29a760b48b38ef3955155f7d867" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">创建一个 session 存储在数据库（或者 redis）
将 session ID 放进 cookie 中，被存储在用户浏览器中。</span></span></p></div><div id="https://www.notion.so/a41c565857fd410fb11984ff2ffe6534" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">再次发起请求，服务器直接通过 session ID 对用户进行验证</span></span></p></div><div id="https://www.notion.so/c128a7ffd62f49539118cc6a2503d852" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">一旦用户登出，则 session 在客户端和服务器端都被销毁</span></span></p></div><h2 id="https://www.notion.so/a33f70f6ab654daa954922a58e35598c" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/a33f70f6ab654daa954922a58e35598c"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">token</span></span></h2><h3 id="https://www.notion.so/c2ce0914a64949e1b102e4ab8eb86712" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--3"><a class="Anchor" href="#https://www.notion.so/c2ce0914a64949e1b102e4ab8eb86712"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">用户输入登录信息服务器判断登录信息正确，返回一个 tokentoken 存储在客户端，大多数通常在 local storage，但是也可以存储在 session storage 或者 cookie 中。</span></span></h3><div id="https://www.notion.so/25507796b53c44ea81a0825af902e671" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">接着发起请求的时候将 token 放进 Authorization header，或者同样可以通过上面的方式。</span></span></p></div><div id="https://www.notion.so/24ea4d591d4a4be580187f435280bbf6" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">服务器端解码 JWT 然后验证 token，如果 token 有效，则处理该请求。</span></span></p></div><div id="https://www.notion.so/93972ff5375542bc94ba339ca646d5a8" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">一旦用户登出，token 在客户端被销毁，不需要经过服务器端。</span></span></p></div><h1 id="https://www.notion.so/513c998e9ec2492babccdabf96465d7e" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--1"><a class="Anchor" href="#https://www.notion.so/513c998e9ec2492babccdabf96465d7e"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">Token加密问题</span></span></h1><h2 id="https://www.notion.so/cc813867d95340dc902651614ebcc05b" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/cc813867d95340dc902651614ebcc05b"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">单向加密</span></span></h2><h3 id="https://www.notion.so/f404090c77e248f89b3b4f1b5f4e4e65" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--3"><a class="Anchor" href="#https://www.notion.so/f404090c77e248f89b3b4f1b5f4e4e65"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">MD5</span></span></h3><div id="https://www.notion.so/717be19c0c8443938c1be3ec2b366057" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"> 一般来说</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">MD5</code></span><span class="SemanticString">通过彩虹表（一张使用各种hash算法生成的明文密文对照表）还是可以破解的，通常会考虑“加盐（salt）”，这个salt可以看作是一个额外的“认证码”，同样的输入，不同的认证码，会产生不同的输出。因此，要验证输出的哈希，必须同时提供“认证码”，也不用自己手动去搞了，使用下面介绍的Hmac算法吧。</span></span></p></div><h3 id="https://www.notion.so/7ab92376cfdd45498d8cc5324142ac03" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--3"><a class="Anchor" href="#https://www.notion.so/7ab92376cfdd45498d8cc5324142ac03"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">Hmac</strong></span></span></h3><div id="https://www.notion.so/bd2942ba63694021860359db213d1947" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">Hmac</code></span><span class="SemanticString">全称为Hash-based Message Authentication Code， 就是一种基于密钥的消息认证码算法，也是一种更安全的消息摘要算法。</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">Hmac</code></span><span class="SemanticString">算法总是和某种哈希算法配合起来用的。例如，我们使用</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">MD5</code></span><span class="SemanticString">算法，对应的就是</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">HmacMD5</code></span><span class="SemanticString">算法，它相当于“加盐”的</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">MD5</code></span><span class="SemanticString">，同时生成密文的长度和使用源HASH算法生成的密文长度一样。比如还有: </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">HmacMD5/HmacSHA1/HmacSHA256/HmacSHA384/HmacSHA512</code></span><span class="SemanticString">。</span></span></p></div><h2 id="https://www.notion.so/597602c731f145e4a8bdce0f59d7837c" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/597602c731f145e4a8bdce0f59d7837c"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">双向加密</span></span></h2><h3 id="https://www.notion.so/cc4c16cac95f4cd4a47831924fed1c14" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--3"><a class="Anchor" href="#https://www.notion.so/cc4c16cac95f4cd4a47831924fed1c14"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">对称加密-DES 3DES AES</span></span></h3><div id="https://www.notion.so/a57b103424fd4912a49c3c104736bf9d" class="Image Image--PageWidth"><figure><a href="https://prod-files-secure.s3.us-west-2.amazonaws.com/97f60ed7-2f91-4328-9e16-bcc075d7c8a7/9e2ca8b6-c076-4ed5-bf99-9eb624205632/Untitled.png?width=1610"><img src="https://prod-files-secure.s3.us-west-2.amazonaws.com/97f60ed7-2f91-4328-9e16-bcc075d7c8a7/9e2ca8b6-c076-4ed5-bf99-9eb624205632/Untitled.png?width=1610" style="width:100%"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div><h3 id="https://www.notion.so/38dd35a7874c48fe8a2d56a93a588f85" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--3"><a class="Anchor" href="#https://www.notion.so/38dd35a7874c48fe8a2d56a93a588f85"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">非对称加密-RSA算法</span></span></h3><div id="https://www.notion.so/3d3f2bfd04c340b5a4c4ed9d999e88c6" class="Image Image--PageWidth"><figure><a href="https://prod-files-secure.s3.us-west-2.amazonaws.com/97f60ed7-2f91-4328-9e16-bcc075d7c8a7/d33fbee3-1ffc-4650-b667-072de97d10c8/Untitled.png?width=1548"><img src="https://prod-files-secure.s3.us-west-2.amazonaws.com/97f60ed7-2f91-4328-9e16-bcc075d7c8a7/d33fbee3-1ffc-4650-b667-072de97d10c8/Untitled.png?width=1548" style="width:100%"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div><h2 id="https://www.notion.so/fb30b74e9b934e889674de6093f98458" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/fb30b74e9b934e889674de6093f98458"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">利用加密算法实现一个token</span></span></h2><div id="https://www.notion.so/af64d80169f54f94b1a751b05d6228ac" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">需要进行身份验证的时候，目前比较流行的是服务端来下方令牌token，后续客户端带着这个令牌来请求服务端，服务端再进行身份验证。</span></span></p></div><div id="https://www.notion.so/0e75bd8be4864e23be1143be9c1b8f8a" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"> Token有两个很重要的特性:</span></span></p></div><ul class="BulletedListWrapper"><li id="https://www.notion.so/42e5f381ef234d6c9eefa13334c63423" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">一个是随机性，不可预测，当然token会包含一些必要的信息，比如实例信息；</span></span></li><li id="https://www.notion.so/25acfd024ee640579a892e96640cf2da" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">另一个是存在过期时间；</span></span><div id="https://www.notion.so/34cac951b87548a199e5d9cbbb02f68d" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">当然还有再刷新refresh功能，但是首要的是满足上面两个条件，下面就写一个可以实际使用的token。其中，</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">createToken(T tokenBody, int minute)</code></span><span class="SemanticString">表示生成token，</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">verify</code></span><span class="SemanticString">为检验token</span></span></p></div></li></ul><pre id="https://www.notion.so/e49abb2d480a447ca7d427cc052a4fca" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>google<span class="token punctuation">.</span>common<span class="token punctuation">.</span>base<span class="token punctuation">.</span></span><span class="token class-name">Joiner</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>google<span class="token punctuation">.</span>common<span class="token punctuation">.</span>base<span class="token punctuation">.</span></span><span class="token class-name">Splitter</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>google<span class="token punctuation">.</span>gson<span class="token punctuation">.</span></span><span class="token operator">*</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>codec<span class="token punctuation">.</span>binary<span class="token punctuation">.</span></span><span class="token class-name">Base64</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>lang3<span class="token punctuation">.</span></span><span class="token class-name">RandomStringUtils</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>crypto<span class="token punctuation">.</span></span><span class="token class-name">Cipher</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>crypto<span class="token punctuation">.</span></span><span class="token class-name">KeyGenerator</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>crypto<span class="token punctuation">.</span></span><span class="token class-name">Mac</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>crypto<span class="token punctuation">.</span>spec<span class="token punctuation">.</span></span><span class="token class-name">SecretKeySpec</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>security<span class="token punctuation">.</span></span><span class="token class-name">Key</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>security<span class="token punctuation">.</span></span><span class="token class-name">NoSuchAlgorithmException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>security<span class="token punctuation">.</span></span><span class="token class-name">SecureRandom</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Arrays</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span></span><span class="token punctuation">;</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TokenUtil</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Key</span> aesKey <span class="token operator">=</span> <span class="token function">getAESKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">String</span> hmacKey <span class="token operator">=</span> <span class="token string">"wSpJSBADgHgGIjdA9jvLzQ=="</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Status</span> <span class="token punctuation">{</span>
        <span class="token keyword">private</span> <span class="token keyword">int</span> code<span class="token punctuation">;</span>
        <span class="token keyword">private</span> <span class="token class-name">String</span> message<span class="token punctuation">;</span>

        <span class="token keyword">public</span> <span class="token class-name">Status</span><span class="token punctuation">(</span><span class="token keyword">int</span> code<span class="token punctuation">,</span> <span class="token class-name">String</span> message<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>code <span class="token operator">=</span> code<span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>message <span class="token operator">=</span> message<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token string">"Status{"</span> <span class="token operator">+</span>
                    <span class="token string">"code="</span> <span class="token operator">+</span> code <span class="token operator">+</span>
                    <span class="token string">", message='"</span> <span class="token operator">+</span> message <span class="token operator">+</span> <span class="token char">'\''</span> <span class="token operator">+</span>
                    <span class="token char">'}'</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Student</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> id<span class="token punctuation">;</span>
        <span class="token class-name">String</span> name<span class="token punctuation">;</span>

        <span class="token keyword">public</span> <span class="token class-name">Student</span><span class="token punctuation">(</span><span class="token keyword">int</span> id<span class="token punctuation">,</span> <span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>id <span class="token operator">=</span> id<span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 校验token，主要是校验两个方面
     * 1、校验签名是否合法
     * 2、校验token是否过期
     * @param token
     * @return
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Status</span> <span class="token function">verify</span><span class="token punctuation">(</span><span class="token class-name">String</span> token<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> list <span class="token operator">=</span> <span class="token class-name">Splitter</span><span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token char">'.'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">splitToList</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>list<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Status</span><span class="token punctuation">(</span><span class="token number">5000</span><span class="token punctuation">,</span> <span class="token string">"token length is not valid"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">String</span> encryptJson <span class="token operator">=</span> list<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> sign <span class="token operator">=</span> list<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> headerJson <span class="token operator">=</span> list<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">verifySign</span><span class="token punctuation">(</span>encryptJson<span class="token punctuation">,</span> sign<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Status</span><span class="token punctuation">(</span><span class="token number">5001</span><span class="token punctuation">,</span> <span class="token string">"invalid token"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">verifyExpire</span><span class="token punctuation">(</span>headerJson<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Status</span><span class="token punctuation">(</span><span class="token number">5002</span><span class="token punctuation">,</span> <span class="token string">"token has time out"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Status</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span> <span class="token string">"success"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 校验token是否过期
     * @param headerJson  请求头的base64编码
     * @return
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">boolean</span> <span class="token function">verifyExpire</span><span class="token punctuation">(</span><span class="token class-name">String</span> headerJson<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> headerBytes <span class="token operator">=</span> <span class="token function">base64Decoder</span><span class="token punctuation">(</span>headerJson<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> json <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>headerBytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">JsonObject</span> jsonObject <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">JsonObject</span><span class="token punctuation">)</span><span class="token keyword">new</span> <span class="token class-name">JsonParser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>json<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">JsonElement</span> element <span class="token operator">=</span> jsonObject<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"expire"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">long</span> expireTime <span class="token operator">=</span> element<span class="token punctuation">.</span><span class="token function">getAsLong</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> expireTime <span class="token operator">></span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">1000</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     *校验签名  使用base64解码后的字节数组来生成签名，并与传递来的签名进行比较得出合法性
     * @param encryptJson
     * @param sign
     * @return
     * @throws Exception
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">boolean</span> <span class="token function">verifySign</span><span class="token punctuation">(</span><span class="token class-name">String</span> encryptJson<span class="token punctuation">,</span> <span class="token class-name">String</span> sign<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">{</span>
        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> encryptBody <span class="token operator">=</span> <span class="token function">base64Decoder</span><span class="token punctuation">(</span>encryptJson<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> bytes <span class="token operator">=</span> <span class="token function">generateHmacSign</span><span class="token punctuation">(</span>encryptBody<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>sign<span class="token punctuation">,</span> <span class="token function">base64Encoder</span><span class="token punctuation">(</span>bytes<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token class-name">AESDecryptBody</span><span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> encryptBody<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">{</span>
        <span class="token class-name">Cipher</span> cipher <span class="token operator">=</span> <span class="token class-name">Cipher</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token string">"AES"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        cipher<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token class-name">Cipher</span><span class="token punctuation">.</span><span class="token constant">DECRYPT_MODE</span><span class="token punctuation">,</span> aesKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> cipher<span class="token punctuation">.</span><span class="token function">doFinal</span><span class="token punctuation">(</span>encryptBody<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     *
     * @param tokenBody 实例对象，通常为bean
     * @param minute 过期时间   单位:min
     * @param &lt;T>
     * @return
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token class-name">String</span> <span class="token function">createToken</span><span class="token punctuation">(</span><span class="token class-name">T</span> tokenBody<span class="token punctuation">,</span> <span class="token keyword">int</span> minute<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">long</span> now <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">1000</span><span class="token punctuation">;</span>
        <span class="token class-name">Gson</span> gson <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Gson</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">JsonObject</span> jsonBody <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JsonObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        jsonBody<span class="token punctuation">.</span><span class="token function">addProperty</span><span class="token punctuation">(</span><span class="token string">"body"</span><span class="token punctuation">,</span> gson<span class="token punctuation">.</span><span class="token function">toJson</span><span class="token punctuation">(</span>tokenBody<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">String</span> randomAlphabetic <span class="token operator">=</span> <span class="token class-name">RandomStringUtils</span><span class="token punctuation">.</span><span class="token function">randomAlphabetic</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">JsonObject</span> jsonHeader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JsonObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        jsonHeader<span class="token punctuation">.</span><span class="token function">addProperty</span><span class="token punctuation">(</span><span class="token string">"now"</span><span class="token punctuation">,</span> now<span class="token punctuation">)</span><span class="token punctuation">;</span>
        jsonHeader<span class="token punctuation">.</span><span class="token function">addProperty</span><span class="token punctuation">(</span><span class="token string">"rand_num"</span><span class="token punctuation">,</span> randomAlphabetic<span class="token punctuation">)</span><span class="token punctuation">;</span>
        jsonHeader<span class="token punctuation">.</span><span class="token function">addProperty</span><span class="token punctuation">(</span><span class="token string">"expire"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>now <span class="token operator">+</span> minute <span class="token operator">*</span> <span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">String</span> token <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> encryptContent <span class="token operator">=</span> <span class="token function">generateEncryptBody</span><span class="token punctuation">(</span>jsonHeader<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> jsonHeader<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> signWithEncrypt <span class="token operator">=</span> <span class="token function">generateSignWithEncrypt</span><span class="token punctuation">(</span>encryptContent<span class="token punctuation">)</span><span class="token punctuation">;</span>
            token <span class="token operator">=</span> <span class="token class-name">Joiner</span><span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">"."</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token function">base64Encoder</span><span class="token punctuation">(</span>
                    jsonHeader<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token string">"utf-8"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token function">base64Encoder</span><span class="token punctuation">(</span>encryptContent<span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token function">base64Encoder</span><span class="token punctuation">(</span>signWithEncrypt<span class="token punctuation">)</span><span class="token punctuation">}</span>
                    <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> token<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">generateEncryptBody</span><span class="token punctuation">(</span><span class="token class-name">String</span> header<span class="token punctuation">,</span> <span class="token class-name">String</span> body<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">{</span>
        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> headerBytes <span class="token operator">=</span> header<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token string">"utf-8"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> bodyBytes <span class="token operator">=</span> body<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token string">"utf-8"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> content <span class="token operator">=</span> <span class="token function">xor</span><span class="token punctuation">(</span>headerBytes<span class="token punctuation">,</span> bodyBytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> encryptContent <span class="token operator">=</span> <span class="token class-name">AESEncrypt</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> encryptContent<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">generateSignWithEncrypt</span><span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> encryptContent<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">{</span>
        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> result <span class="token operator">=</span> <span class="token function">generateHmacSign</span><span class="token punctuation">(</span>encryptContent<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">generateHmacSign</span><span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> content<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">SecretKeySpec</span> secretKey <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SecretKeySpec</span><span class="token punctuation">(</span>hmacKey<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token string">"utf-8"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"HmacMD5"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Mac</span> mac <span class="token operator">=</span> <span class="token class-name">Mac</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token string">"HmacMD5"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mac<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span>secretKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> mac<span class="token punctuation">.</span><span class="token function">doFinal</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">base64Encoder</span><span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">Base64</span><span class="token punctuation">.</span><span class="token function">encodeBase64String</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">base64Decoder</span><span class="token punctuation">(</span><span class="token class-name">String</span> content<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">Base64</span><span class="token punctuation">.</span><span class="token function">decodeBase64</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">xor</span><span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> header<span class="token punctuation">,</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> body<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> xorData <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span>body<span class="token punctuation">.</span>length<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> body<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">int</span> idx <span class="token operator">=</span> i <span class="token operator">%</span> header<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
            xorData<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span><span class="token punctuation">(</span>body<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">^</span> header<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> xorData<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Key</span> <span class="token function">getAESKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Key</span> key <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">KeyGenerator</span> keyGenerator <span class="token operator">=</span> <span class="token class-name">KeyGenerator</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token string">"AES"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            keyGenerator<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">SecureRandom</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> encodedKey <span class="token operator">=</span> keyGenerator<span class="token punctuation">.</span><span class="token function">generateKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getEncoded</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            key <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SecretKeySpec</span><span class="token punctuation">(</span>encodedKey<span class="token punctuation">,</span> <span class="token string">"AES"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NoSuchAlgorithmException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> key<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token class-name">AESEncrypt</span><span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> content<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">Cipher</span> cipher <span class="token operator">=</span> <span class="token class-name">Cipher</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token string">"AES"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        cipher<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token class-name">Cipher</span><span class="token punctuation">.</span><span class="token constant">ENCRYPT_MODE</span><span class="token punctuation">,</span> aesKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> cipher<span class="token punctuation">.</span><span class="token function">doFinal</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token class-name">AESDecrypt</span><span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> content<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">Cipher</span> cipher <span class="token operator">=</span> <span class="token class-name">Cipher</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token string">"AES"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        cipher<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token class-name">Cipher</span><span class="token punctuation">.</span><span class="token constant">DECRYPT_MODE</span><span class="token punctuation">,</span> aesKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> cipher<span class="token punctuation">.</span><span class="token function">doFinal</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> token <span class="token operator">=</span> <span class="token function">createToken</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Student</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"tom"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Status</span> status <span class="token operator">=</span> <span class="token function">verify</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token function">verify</span><span class="token punctuation">(</span>token <span class="token operator">+</span> <span class="token string">"ab"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">70000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token function">verify</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></span></span></span></code></pre><h1 id="https://www.notion.so/842f0b879955417f82ded24ebf51a243" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--1"><a class="Anchor" href="#https://www.notion.so/842f0b879955417f82ded24ebf51a243"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">Token中都存储什么信息</span></span></h1><div id="https://www.notion.so/d05e20a0dfb840e8809daec711ead1f5" class="Image Image--PageWidth"><figure><a href="https://prod-files-secure.s3.us-west-2.amazonaws.com/97f60ed7-2f91-4328-9e16-bcc075d7c8a7/256db7e3-2386-4240-809e-bca19ded561d/Untitled.png?width=1340"><img src="https://prod-files-secure.s3.us-west-2.amazonaws.com/97f60ed7-2f91-4328-9e16-bcc075d7c8a7/256db7e3-2386-4240-809e-bca19ded561d/Untitled.png?width=1340" style="width:100%"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div><div id="https://www.notion.so/5d28afcd1e9a4bad932fd47797b7bd42" class="Image Image--PageWidth"><figure><a href="https://prod-files-secure.s3.us-west-2.amazonaws.com/97f60ed7-2f91-4328-9e16-bcc075d7c8a7/788296d5-b2a2-4da8-9958-6aa1c0630711/Untitled.png?width=1386"><img src="https://prod-files-secure.s3.us-west-2.amazonaws.com/97f60ed7-2f91-4328-9e16-bcc075d7c8a7/788296d5-b2a2-4da8-9958-6aa1c0630711/Untitled.png?width=1386" style="width:100%"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div><div id="https://www.notion.so/05330311ff3c427783a46f07aae73e47" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/9bae675a71654922987a2b499e636cc4" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><h1 id="https://www.notion.so/5f2f2edcace4426088663428c510456e" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--1"><a class="Anchor" href="#https://www.notion.so/5f2f2edcace4426088663428c510456e"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">Token过期刷新策略（利用Redis）（大型项目）</span></span></h1><div id="https://www.notion.so/b8fa7e9dccd84a20a8cf8ff91b31c3a4" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">参考文章：</span></span></p></div><div id="https://www.notion.so/a85935a3b6f442a59a61d59d89ea9407" class="Bookmark"><a href="https://juejin.cn/post/6844904160018563086"><h5 class="Bookmark__Title">token超时刷新策略(附源码） - 掘金</h5><p class="Bookmark__Desc">我们在做用户中心时，对于登录用户签发其对应的token，对token设置他的固定有效期时间。可是我们通常会遇到一个这样的问题：在有效期内用户携带token访问没问题，当过了有效期后token失效，用户需要重新登录获取新的token。 想象以下，假如生产环境中我把token时间设…</p><p class="Bookmark__Link">https://juejin.cn/post/6844904160018563086</p></a></div><div id="https://www.notion.so/9352df3b30494b6daa07fcc98df06d27" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">业务目标：</span></span></p></div><div id="https://www.notion.so/01adb322b5fb48d780ec1cd9db8b0984" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">一个优秀的体验应该是：活跃的用户应该在无感知的情况下在token失效后获取到新的token，携带这个新的token进行访问，而长时间不活跃的用户应该在token失效后需要重新进行登录认证。也就是所谓的token刷新机制。</span></span></p></div><h2 id="https://www.notion.so/16956852e3f24beb85e0887455cfd42b" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/16956852e3f24beb85e0887455cfd42b"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">设计思路</span></span></h2><div id="https://www.notion.so/40a9f5b534fc4534b03d0a72c30ce3dc" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">用户登录时，为登录用户签发JWT，并设置JWT的有效时间，同时将该用户的JWT保存至redis缓存中，并设置缓存的有效期，缓存中保存的JWT的有效期要大于JWT本身的有效时间。其中：</span><span class="SemanticString"><em class="SemanticString__Fragment SemanticString__Fragment--Italic">缓存时间-JWT有效时间=token可刷新时间</em></span></span></p></div><div id="https://www.notion.so/86d9034b5bf846b1a153ea8e4c4fb505" class="Image Image--PageWidth"><figure><a href="https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2Fa0e07d6e-b098-4fb2-bfbb-f30d602f99c7%2FUntitled.png?width=1230&amp;table=block&amp;id=86d9034b-5bf8-46b1-a153-ea8e4c4fb505"><img src="https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2Fa0e07d6e-b098-4fb2-bfbb-f30d602f99c7%2FUntitled.png?width=1230&amp;table=block&amp;id=86d9034b-5bf8-46b1-a153-ea8e4c4fb505" style="width:100%"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div><div id="https://www.notion.so/b5fe2fe492c8467f9ad71f782261acde" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><h1 id="https://www.notion.so/4a66c87925e940318db0860b8e1fa03a" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--1"><a class="Anchor" href="#https://www.notion.so/4a66c87925e940318db0860b8e1fa03a"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">二次迭代（小型项目）</span></span></h1><div id="https://www.notion.so/ad7c3b921c934041a6fe5a29b4776693" class="Bookmark"><a href="https://www.zhihu.com/question/274566992"><h5 class="Bookmark__Title">jwt与token+redis，哪种方案更好用？ - 知乎</h5><p class="Bookmark__Desc">在设计no session系统时，遇到了有两种可选方案：jwt与token+redis。JWT: 生成并发给客户端之后，后台是…</p><p class="Bookmark__Link">https://www.zhihu.com/question/274566992</p></a></div><div id="https://www.notion.so/745be554dbd1403fa18e9cc5d025dd85" class="Image Image--PageWidth"><figure><a href="https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F36233fa6-70b2-4733-921a-0cb35ddef707%2FUntitled.png?width=1020&amp;table=block&amp;id=745be554-dbd1-403f-a18e-9cc5d025dd85"><img src="https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F36233fa6-70b2-4733-921a-0cb35ddef707%2FUntitled.png?width=1020&amp;table=block&amp;id=745be554-dbd1-403f-a18e-9cc5d025dd85" style="width:100%"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div><div id="https://www.notion.so/05152894ba8544b9a8fbfae9933dd47f" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/03ca036c2ab3470da0cc27813505f167" class="Bookmark"><a href="https://www.zhihu.com/question/274566992"><h5 class="Bookmark__Title">jwt与token+redis，哪种方案更好用？ - 知乎</h5><p class="Bookmark__Desc">在设计no session系统时，遇到了有两种可选方案：jwt与token+redis。JWT: 生成并发给客户端之后，后台是…</p><p class="Bookmark__Link">https://www.zhihu.com/question/274566992</p></a></div><div id="https://www.notion.so/24966a6e87594f11ba0a21714987d54c" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">token泄露的话，服务器也只能任其蹂躏，在其未过期期间不能有任何措施。</span></span></p></div><div id="https://www.notion.so/8788e08e46984990b0d0d56a77ee71e9" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">常见的做法是从 jwt 上再封装一层，提供一个类似黑名单的机制，每次访问系统时先检查此 jwt 令牌是否已经被拉黑。但是这种方式一方面违背了jwt无状态的初衷，另一方面也可以简化成迭代后的解决方式就是，使用Token（Cookie）+Redis</span></span></p></div><div id="https://www.notion.so/62d3c6f92efb494e83f629cad602dadb" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/d7b33892dad0439e910a00afeadfd461" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">还是使用Token，Token的验证交由Redis</span></span></p></div><div id="https://www.notion.so/9577ecc493de47b3bf2d18b949e88e55" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">这样就既能保证分布式系统（大概）（Token好处），又能对Token进行过期处理（Cookie好处）（比如退出是的删除Token）</span></span></p></div><div id="https://www.notion.so/67e8f90050b842ada9af791ebc13c983" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/70318907b5844966ac68b970b332c4bf" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">至于Token泄露问题，目前的打算是将IP地址也存入</span></span></p></div><div id="https://www.notion.so/6be6df8ba3d34db79d3837c59ea56fc3" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">将会比较redis中的ip地址与请求的ip地址</span></span></p></div><div id="https://www.notion.so/c9d39ff139fa4dcfa26cc7d5c0d5833c" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/39e0f46ba3774ca4b78f69d9a56373c7" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">加密问题，使用双向加密</span></span></p></div><div id="https://www.notion.so/dd13d50753b34e65bc7b9ebdaa68caaa" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div></article>
  <footer class="Footer">
  <div>&copy; 沂风 2022</div>
  <div>&centerdot;</div>
  <div>Powered by <a href="https://github.com/dragonman225/notablog" target="_blank"
      rel="noopener noreferrer">Notablog</a>.
  </div>
</footer>
</body>

</html>